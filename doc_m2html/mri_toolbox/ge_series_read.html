<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of ge_series_read</title>
  <meta name="keywords" content="ge_series_read">
  <meta name="description" content="ge_series_read - reads a volume of images from a GE series">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">mri_toolbox</a> &gt; ge_series_read.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for mri_toolbox&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>ge_series_read
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>ge_series_read - reads a volume of images from a GE series</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function [ ge, lastfile ] = ge_series_read(examPath, series) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"> ge_series_read - reads a volume of images from a GE series
 
 [ ge, lastfile ] = ge_series_read(examPath, seriesPath)
 
 examPath    - string path to exam directory
 seriesPath  - string path to series directory, 
               relative to examPath
 
 reads the volume of files in seriesPath, which is stored
 under examPath (it can return the name of the last file read).
 
 The files are assumed to be arranged in series subdirectories
 below the examPath, so series files would be located as such:
 examPath/seriesN/*.MR or examPath/seriesN/I.*.  The function 
 will try to find all *.MR or I.* files and determine the 
 correct numerical order of the image files.
 
 The function assumes the GE files are big endian.  This is
 an example of the returned struct, where ge.img contains
 the image volume data:
 
 ge = 
 
      pix_hdr: [1x1 struct]
    img.offset: 8432
       su_hdr: [1x1 struct]
       ex_hdr: [1x1 struct]
       se_hdr: [1x1 struct]
       hdr.image: [1x1 struct]
          img: [256x256x11 double]
 
 see also <a href="ge_hdr_read.html" class="code" title="function [ ge ] = ge_hdr_read(imageFileName)">ge_hdr_read</a>, <a href="ge_series2avw.html" class="code" title="function [ avw ] = ge_series2avw(examPath,seriesPath)">ge_series2avw</a></pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="ge_hdr_read.html" class="code" title="function [ ge ] = ge_hdr_read(imageFileName)">ge_hdr_read</a>	ge_hdr_read - Reads the header info from a GE LX2 or 5.X file</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="ge_series2avw.html" class="code" title="function [ avw ] = ge_series2avw(examPath,seriesPath)">ge_series2avw</a>	ge_series2avw - converts a GE series to Analyze</li><li><a href="mri_open.html" class="code" title="function [mri] = mri_open(mri)">mri_open</a>	mri_open - function to call various mri data tools</li></ul>
<!-- crossreference -->


<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [ ge, lastfile ] = ge_series_read(examPath, series)</a>
0002 
0003 <span class="comment">% ge_series_read - reads a volume of images from a GE series</span>
0004 <span class="comment">%</span>
0005 <span class="comment">% [ ge, lastfile ] = ge_series_read(examPath, seriesPath)</span>
0006 <span class="comment">%</span>
0007 <span class="comment">% examPath    - string path to exam directory</span>
0008 <span class="comment">% seriesPath  - string path to series directory,</span>
0009 <span class="comment">%               relative to examPath</span>
0010 <span class="comment">%</span>
0011 <span class="comment">% reads the volume of files in seriesPath, which is stored</span>
0012 <span class="comment">% under examPath (it can return the name of the last file read).</span>
0013 <span class="comment">%</span>
0014 <span class="comment">% The files are assumed to be arranged in series subdirectories</span>
0015 <span class="comment">% below the examPath, so series files would be located as such:</span>
0016 <span class="comment">% examPath/seriesN/*.MR or examPath/seriesN/I.*.  The function</span>
0017 <span class="comment">% will try to find all *.MR or I.* files and determine the</span>
0018 <span class="comment">% correct numerical order of the image files.</span>
0019 <span class="comment">%</span>
0020 <span class="comment">% The function assumes the GE files are big endian.  This is</span>
0021 <span class="comment">% an example of the returned struct, where ge.img contains</span>
0022 <span class="comment">% the image volume data:</span>
0023 <span class="comment">%</span>
0024 <span class="comment">% ge =</span>
0025 <span class="comment">%</span>
0026 <span class="comment">%      pix_hdr: [1x1 struct]</span>
0027 <span class="comment">%    img.offset: 8432</span>
0028 <span class="comment">%       su_hdr: [1x1 struct]</span>
0029 <span class="comment">%       ex_hdr: [1x1 struct]</span>
0030 <span class="comment">%       se_hdr: [1x1 struct]</span>
0031 <span class="comment">%       hdr.image: [1x1 struct]</span>
0032 <span class="comment">%          img: [256x256x11 double]</span>
0033 <span class="comment">%</span>
0034 <span class="comment">% see also ge_hdr_read, ge_series2avw</span>
0035 <span class="comment">%</span>
0036 
0037 
0038 <span class="comment">% $Revision: 1.2 $ $Date: 2004/04/08 20:11:24 $</span>
0039 
0040 <span class="comment">% Licence: GPL, no express or implied warranties</span>
0041 <span class="comment">%</span>
0042 <span class="comment">% Souheil J. Inati  &lt;souheil.inati@nyu.edu&gt; at 03/2003</span>
0043 <span class="comment">% Dartmouth College, May 2000</span>
0044 <span class="comment">%</span>
0045 <span class="comment">% Darren.Weber@flinders.edu.au, March 2003</span>
0046 <span class="comment">% - Substantially redesigned file handling and function</span>
0047 <span class="comment">%   call structures for integration with mri_toolbox at</span>
0048 <span class="comment">%   http://eeg.sf.net</span>
0049 <span class="comment">% - Requested permission to distribute code under GPL licence</span>
0050 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0051 
0052 
0053 version = <span class="string">'[$Revision: 1.2 $]'</span>;
0054 fprintf(<span class="string">'\nGE_SERIES_READ [v%s]\n'</span>,version(12:16));  tic;
0055 
0056 
0057 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0058 <span class="comment">% --- Extract filenames and exam/series/image components</span>
0059 
0060 <span class="comment">% check if series is int</span>
0061 <span class="keyword">if</span> isnumeric(series),
0062     series = num2str(series);
0063 <span class="keyword">end</span>
0064 
0065 seriesPath  = [examPath,filesep,series,filesep];
0066 
0067 fprintf(<span class="string">'...searching for files in: %s\n'</span>,seriesPath);
0068 
0069 <span class="keyword">if</span> exist(seriesPath) ~= 7,
0070     msg = sprintf(<span class="string">'...cannot find path: %s!\n'</span>,seriesPath);
0071     error(msg);
0072 <span class="keyword">end</span>
0073 
0074 dirFiles = dir(seriesPath);
0075 n = 0;
0076 <span class="keyword">for</span> i = 1:length(dirFiles),
0077     <span class="comment">% check whether this file is a directory</span>
0078     <span class="keyword">if</span> ~ dirFiles(i).isdir,
0079         <span class="comment">% check whether it ends with .MR</span>
0080         <span class="keyword">if</span> findstr(dirFiles(i).name,<span class="string">'.MR'</span>),
0081             <span class="comment">%fprintf(sprintf('found *.MR file: %s\n',dirFiles(i).name));</span>
0082             n = n + 1;
0083             seriesFileNames{n} = dirFiles(i).name;
0084             imageFormat = <span class="string">'MR'</span>;
0085         <span class="keyword">elseif</span> findstr(dirFiles(i).name,<span class="string">'I.'</span>),
0086             <span class="comment">%fprintf(sprintf('found I. file: %s\n',dirFiles(i).name));</span>
0087             n = n + 1;
0088             seriesFileNames{n} = dirFiles(i).name;
0089             imageFormat = <span class="string">'I'</span>;
0090         <span class="keyword">end</span>
0091     <span class="keyword">end</span>
0092 <span class="keyword">end</span>
0093 
0094 <span class="keyword">if</span> n == 0,
0095     msg = sprintf(<span class="string">'...Found %d image files (I.* or *.MR)!\n'</span>,n);
0096     error(msg);
0097 <span class="keyword">else</span>
0098     fprintf(<span class="string">'...Found %d image files\n'</span>,n);
0099 <span class="keyword">end</span>
0100 
0101 <span class="keyword">if</span> isequal(imageFormat,<span class="string">'MR'</span>),
0102     
0103     fprintf(<span class="string">'...sorting *.MR image files into numerical order\n'</span>);
0104     
0105     <span class="comment">% extract exam/series/image numbers and sort into numerical order</span>
0106     fileName.position.exam   = findstr(seriesFileNames{1},<span class="string">'E'</span>);
0107     fileName.position.series = findstr(seriesFileNames{1},<span class="string">'S'</span>);
0108     fileName.position.image  = findstr(seriesFileNames{1},<span class="string">'I'</span>);
0109     
0110     range = [ (fileName.position.exam + 1) : (fileName.position.series - 1) ];
0111     examN = seriesFileNames{1}(range);
0112     
0113     range   = [ (fileName.position.series + 1) : (fileName.position.image - 1) ];
0114     seriesN = seriesFileNames{1}(range);
0115     
0116     <span class="keyword">for</span> i = 1:length(seriesFileNames),
0117         range = [ fileName.position.image + 1 ];
0118         imageNumbers{i} = seriesFileNames{i}(range:end);
0119         imageNumbers{i} = strrep(imageNumbers{i},<span class="string">'.MR'</span>,<span class="string">''</span>);
0120     <span class="keyword">end</span>
0121     imageNumbers = str2double(imageNumbers);
0122     [n,i] = sort(imageNumbers);
0123     
0124     sortedFileNames = seriesFileNames(i);
0125     
0126 <span class="keyword">elseif</span> isequal(imageFormat, <span class="string">'I'</span>),
0127     
0128     fprintf(<span class="string">'...sorting I.* image files into numerical order\n'</span>);
0129     
0130     <span class="comment">% extract image numbers, which might already be in numerical order</span>
0131     
0132     <span class="keyword">for</span> i = 1:length(seriesFileNames),
0133         imageNumbers{i} = seriesFileNames{i}(3:end);
0134     <span class="keyword">end</span>
0135     imageNumbers = str2double(imageNumbers);
0136     [n,i] = sort(imageNumbers);
0137     
0138     sortedFileNames = seriesFileNames(i);
0139     
0140 <span class="keyword">end</span>
0141 
0142 <span class="comment">% --- Create the name of the first file in examPath</span>
0143 firstfile = fullfile(seriesPath,sortedFileNames{1});
0144 
0145 
0146 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0147 <span class="comment">% --- Read the header from the first file in the series</span>
0148 ge = <a href="ge_hdr_read.html" class="code" title="function [ ge ] = ge_hdr_read(imageFileName)">ge_hdr_read</a>(firstfile);
0149 
0150 
0151 
0152 im_offset = ge.img.offset;  <span class="comment">% this is not so good, as the ge.img is replaced below!</span>
0153 
0154 
0155 
0156 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0157 <span class="comment">% --- Read the image data from the GE series files</span>
0158 
0159 version = <span class="string">'[$Revision: 1.2 $]'</span>;
0160 fprintf(<span class="string">'\nGE_SERIES_READ [v%s]\n'</span>,version(12:16));
0161 fprintf(<span class="string">'...reading image data\n'</span>);
0162 
0163 <span class="comment">% initialize some variables</span>
0164 nX = ge.hdr.image.imatrix_X; <span class="comment">% X Voxels</span>
0165 nY = ge.hdr.image.imatrix_Y; <span class="comment">% Y Voxels</span>
0166 nZ = ge.hdr.image.slquant;   <span class="comment">% Z Voxels (slice quantity)</span>
0167 
0168 sliceSize = nX*nY;
0169 ge.img = zeros(nX, nY, nZ);
0170 
0171 fprintf(<span class="string">'...reading '</span>);
0172 
0173 <span class="keyword">for</span> i = 1:nZ,
0174     
0175     imageFile = fullfile(seriesPath,sortedFileNames{i});
0176     
0177     <span class="comment">% output filename to indicate progress</span>
0178     <span class="keyword">if</span> i == 1,
0179         backspaces = <span class="string">''</span>;
0180     <span class="keyword">else</span>
0181         filePreviousLength = length(fullfile(seriesPath,sortedFileNames{i-1}));
0182         backspaces = repmat(<span class="string">'\b'</span>,1,filePreviousLength);
0183     <span class="keyword">end</span>
0184     fprintf([backspaces,<span class="string">'%s'</span>],imageFile);
0185     
0186     
0187     <span class="comment">% Open the file</span>
0188     [fid,message] = fopen(imageFile,<span class="string">'r'</span>,<span class="string">'b'</span>); <span class="comment">% big endian</span>
0189     <span class="keyword">if</span> (fid == -1)
0190         fprintf(<span class="string">'Cannot Open %s (big endian).\n'</span>,imageFile);
0191         
0192         <span class="comment">% Can try to read little endian (shouldn't be necessary!)</span>
0193         fprintf(<span class="string">'Trying to read little endian\n'</span>);
0194         [fid,message] = fopen(imageFile,<span class="string">'r'</span>,<span class="string">'l'</span>); <span class="comment">% little endian</span>
0195         <span class="keyword">if</span> (fid == -1),
0196             fprintf(<span class="string">'Cannot Open %s (little endian).\n'</span>,imageFile);
0197             <span class="keyword">break</span>
0198         <span class="keyword">end</span>
0199     <span class="keyword">end</span>
0200     
0201     <span class="comment">% Skip the header, goto the data</span>
0202     fseek(fid,im_offset,-1);
0203     <span class="comment">% Read the slice data</span>
0204     buffer = fread(fid,sliceSize,sprintf(<span class="string">'int%d'</span>,ge.hdr.image.screenformat));
0205     <span class="comment">% append the slice to the imageSet</span>
0206     ge.img(:,:,i) = reshape(buffer, nX, nY);
0207     
0208     <span class="comment">% Close the file</span>
0209     status = fclose(fid);
0210     
0211     <span class="comment">% Set the lastfile</span>
0212     lastfile = imageFile;
0213 <span class="keyword">end</span>
0214 
0215 t=toc; fprintf(<span class="string">'\n...done (%5.2f sec).\n'</span>,t);
0216 
0217 <span class="keyword">return</span></pre></div>
<hr><address>Generated on Mon 29-Mar-2004 13:14:32 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/">m2html</a></strong> &copy; 2003</address>
</body>
</html>