<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of emse_open_reg</title>
  <meta name="keywords" content="emse_open_reg">
  <meta name="description" content="EMSE_OPEN_REG - Read EMSE/MRVU coregistration matrices">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">mri_toolbox</a> &gt; emse_open_reg.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for mri_toolbox&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>emse_open_reg
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>EMSE_OPEN_REG - Read EMSE/MRVU coregistration matrices</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function [reg] = emse_open_reg(file) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"> EMSE_OPEN_REG - Read EMSE/MRVU coregistration matrices
 
 [reg] = emse_open_reg(file)

 reg is a struct with the following fields:

 reg.translation - the translation in meters along the
                   x, y and z axes respectively, from 
                   the MRI image frame to head/elec frame.
 
 reg.rotation - The rotation vector contains the angles
                (in radians) about the x, y and z axes, 
                also from the MRI image frame to the 
                head/elec frame.
 
 reg.elec2mri - 'HeadToImageMatrix' is the 4 x 4 matrix 
                containing the electrode to MRI translation and 
                rotation transformations in homogeneous coordinates:
                * the upper left 3 x 3 submatrix is rotations
                  around z, y, x in that order;
                * the rightmost 3 x 1 column is a projection 
                  vector (all zeros here);
                * the bottom 1 x 3 row is a translation vector,
                  equal to -1 * reg.translation here; and
                * the bottom right (1 x 1) scalar is the 
                  homogenous scale unit, usually 1
 
 reg.mri2elec - 'ImageToHeadMatrix' is the inverse of elec2mri,
                ie, reg.mri2elec = inv(reg.elec2mri).
 
 This function also reads the fiducial points and the electrode
 coordinates from the registration file, they are returned into:
 reg.RPA, reg.LPA, reg.NAS, reg.Helec, and reg.Melec.  Each of
 the fiducial structs (RPA,LPA,NAS) contains the electrode
 fiducials in the head space (Hh) and the MRI space (Hm), plus the
 MRI fiducials in the head space (Mh) and the MRI space (Mm).
 
 The transformation matrices (T) multiply a column vector, so that 
 [x', y', z', 1] = [x, y, z, 1] * T;
 where x',y',z' are in the other coordinate system. For example,
 MRI coordinates into head space:
 tmp = [ reg.Melec ones(size(reg.Melec,1),1) ] * reg.mri2elec;
 Note reg.Helec ~= tmp(:,1:3) due to floating point rounding only.
 Similarly, head space (electrodes) into MRI coordinates:
 tmp = [ reg.Helec ones(size(reg.Helec,1),1) ] * reg.elec2mri;
 Note reg.Melec ~= tmp(:,1:3) due to floating point rounding only.
 
 EMSE Note: The origin in the head frame is at or near the center of 
 the skull, while the origin in the image frame is located at the 
 bottom right front corner of the bounding box (and so would be 
 located at the upper left corner of the first axial slice as 
 displayed by MR Viewer).
 
 A useful chapter on homogeneous coordinates, among other things, 
 may be found in Mortenson, M. (1985, Chpt. 8), Geometric Modelling, 
 New York: John Wiley &amp; Sons.</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
</ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
</ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="#_sub1" class="code">function [reg] = read_reg(fid)</a></li></ul>
<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [reg] = emse_open_reg(file)</a>
0002 
0003 <span class="comment">% EMSE_OPEN_REG - Read EMSE/MRVU coregistration matrices</span>
0004 <span class="comment">%</span>
0005 <span class="comment">% [reg] = emse_open_reg(file)</span>
0006 <span class="comment">%</span>
0007 <span class="comment">% reg is a struct with the following fields:</span>
0008 <span class="comment">%</span>
0009 <span class="comment">% reg.translation - the translation in meters along the</span>
0010 <span class="comment">%                   x, y and z axes respectively, from</span>
0011 <span class="comment">%                   the MRI image frame to head/elec frame.</span>
0012 <span class="comment">%</span>
0013 <span class="comment">% reg.rotation - The rotation vector contains the angles</span>
0014 <span class="comment">%                (in radians) about the x, y and z axes,</span>
0015 <span class="comment">%                also from the MRI image frame to the</span>
0016 <span class="comment">%                head/elec frame.</span>
0017 <span class="comment">%</span>
0018 <span class="comment">% reg.elec2mri - 'HeadToImageMatrix' is the 4 x 4 matrix</span>
0019 <span class="comment">%                containing the electrode to MRI translation and</span>
0020 <span class="comment">%                rotation transformations in homogeneous coordinates:</span>
0021 <span class="comment">%                * the upper left 3 x 3 submatrix is rotations</span>
0022 <span class="comment">%                  around z, y, x in that order;</span>
0023 <span class="comment">%                * the rightmost 3 x 1 column is a projection</span>
0024 <span class="comment">%                  vector (all zeros here);</span>
0025 <span class="comment">%                * the bottom 1 x 3 row is a translation vector,</span>
0026 <span class="comment">%                  equal to -1 * reg.translation here; and</span>
0027 <span class="comment">%                * the bottom right (1 x 1) scalar is the</span>
0028 <span class="comment">%                  homogenous scale unit, usually 1</span>
0029 <span class="comment">%</span>
0030 <span class="comment">% reg.mri2elec - 'ImageToHeadMatrix' is the inverse of elec2mri,</span>
0031 <span class="comment">%                ie, reg.mri2elec = inv(reg.elec2mri).</span>
0032 <span class="comment">%</span>
0033 <span class="comment">% This function also reads the fiducial points and the electrode</span>
0034 <span class="comment">% coordinates from the registration file, they are returned into:</span>
0035 <span class="comment">% reg.RPA, reg.LPA, reg.NAS, reg.Helec, and reg.Melec.  Each of</span>
0036 <span class="comment">% the fiducial structs (RPA,LPA,NAS) contains the electrode</span>
0037 <span class="comment">% fiducials in the head space (Hh) and the MRI space (Hm), plus the</span>
0038 <span class="comment">% MRI fiducials in the head space (Mh) and the MRI space (Mm).</span>
0039 <span class="comment">%</span>
0040 <span class="comment">% The transformation matrices (T) multiply a column vector, so that</span>
0041 <span class="comment">% [x', y', z', 1] = [x, y, z, 1] * T;</span>
0042 <span class="comment">% where x',y',z' are in the other coordinate system. For example,</span>
0043 <span class="comment">% MRI coordinates into head space:</span>
0044 <span class="comment">% tmp = [ reg.Melec ones(size(reg.Melec,1),1) ] * reg.mri2elec;</span>
0045 <span class="comment">% Note reg.Helec ~= tmp(:,1:3) due to floating point rounding only.</span>
0046 <span class="comment">% Similarly, head space (electrodes) into MRI coordinates:</span>
0047 <span class="comment">% tmp = [ reg.Helec ones(size(reg.Helec,1),1) ] * reg.elec2mri;</span>
0048 <span class="comment">% Note reg.Melec ~= tmp(:,1:3) due to floating point rounding only.</span>
0049 <span class="comment">%</span>
0050 <span class="comment">% EMSE Note: The origin in the head frame is at or near the center of</span>
0051 <span class="comment">% the skull, while the origin in the image frame is located at the</span>
0052 <span class="comment">% bottom right front corner of the bounding box (and so would be</span>
0053 <span class="comment">% located at the upper left corner of the first axial slice as</span>
0054 <span class="comment">% displayed by MR Viewer).</span>
0055 <span class="comment">%</span>
0056 <span class="comment">% A useful chapter on homogeneous coordinates, among other things,</span>
0057 <span class="comment">% may be found in Mortenson, M. (1985, Chpt. 8), Geometric Modelling,</span>
0058 <span class="comment">% New York: John Wiley &amp; Sons.</span>
0059 <span class="comment">%</span>
0060 
0061 
0062 <span class="comment">% $Revision: 1.2 $ $Date: 2004/04/08 20:11:24 $</span>
0063 
0064 <span class="comment">% Licence:  GNU GPL, no express or implied warranties</span>
0065 <span class="comment">% History:  06/2002, Darren.Weber@flinders.edu.au</span>
0066 <span class="comment">%           09/2002, Darren.Weber@flinders.edu.au</span>
0067 <span class="comment">%                    - transposed HeadToImageMatrix so it</span>
0068 <span class="comment">%                      can be used as described above</span>
0069 <span class="comment">%                    - added reading of most other fields</span>
0070 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0071 
0072 
0073 <span class="keyword">if</span> ~exist(<span class="string">'file'</span>,<span class="string">'var'</span>),
0074     fprintf(<span class="string">'No input file - see help open_emse_reg\n'</span>);
0075     <span class="keyword">return</span>;
0076 <span class="keyword">end</span>
0077 
0078 [path,name,ext] = fileparts(file);
0079 file = fullfile(path,[name ext]);
0080 
0081 [fid,msg] = fopen(file,<span class="string">'r'</span>);
0082 <span class="keyword">if</span> ~isempty(msg), error(msg); <span class="keyword">end</span>
0083 
0084 fprintf(<span class="string">'OPEN_EMSE_REG: Reading registration data...'</span>);
0085 tic
0086 fid = fopen(file,<span class="string">'r'</span>,<span class="string">'ieee-le'</span>);
0087 reg = <a href="#_sub1" class="code" title="subfunction [reg] = read_reg(fid)">read_reg</a>(fid);
0088 fclose(fid);
0089 t = toc;
0090 fprintf(<span class="string">'done (%6.2f sec).\n'</span>,t);
0091 
0092 <span class="keyword">return</span>
0093 
0094 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0095 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0096 <a name="_sub1" href="#_subfunctions" class="code">function [reg] = read_reg(fid)</a>
0097     
0098     <span class="keyword">while</span> 1,
0099         text = fgetl(fid);
0100         <span class="keyword">if</span> ~ischar(text), <span class="keyword">break</span>, <span class="keyword">end</span>
0101         
0102         <span class="keyword">if</span> strmatch(<span class="string">'Offset'</span>,text),
0103             <span class="comment">% Offset is the translation in meters along the x, y and z axes</span>
0104             <span class="comment">% respectively, from the MRI image frame to head/elec frame.</span>
0105             text = strrep(text,sscanf(text,<span class="string">'%c'</span>,8),<span class="string">''</span>);
0106             text = strrep(text,<span class="string">']'</span>,<span class="string">''</span>);
0107             text = strrep(text,<span class="string">','</span>,<span class="string">''</span>);
0108             reg.translation = sscanf(text,<span class="string">'%f'</span>)';
0109         <span class="keyword">end</span>
0110         <span class="keyword">if</span> strmatch(<span class="string">'Rotation'</span>,text),
0111             <span class="comment">% The Rotation vector contains the angles (in radians) about</span>
0112             <span class="comment">% the x, y and z axes, also from the MRI image frame to the</span>
0113             <span class="comment">% head/elec frame.</span>
0114             text = strrep(text,sscanf(text,<span class="string">'%c'</span>,10),<span class="string">''</span>);
0115             text = strrep(text,<span class="string">']'</span>,<span class="string">''</span>);
0116             text = strrep(text,<span class="string">','</span>,<span class="string">''</span>);
0117             reg.rotation = sscanf(text,<span class="string">'%f'</span>)';
0118         <span class="keyword">end</span>
0119         <span class="keyword">if</span> strmatch(<span class="string">'HeadToImageMatrix'</span>,text),
0120             reg.elec2mri = zeros(4,4);
0121             <span class="keyword">for</span> i=1:4,
0122                 text = fgetl(fid);
0123                 reg.elec2mri(i,:) = sscanf(text,<span class="string">'%f'</span>)';
0124             <span class="keyword">end</span>
0125             <span class="comment">% The emse matrix requires transposition</span>
0126             reg.elec2mri = reg.elec2mri';
0127             <span class="comment">% It is more accurate to do this:</span>
0128             reg.mri2elec = inv(reg.elec2mri);
0129         <span class="keyword">end</span>
0130         <span class="comment">% See inverse calculation above to get reg.mri2elec</span>
0131         <span class="comment">%if strmatch('ImageToHeadMatrix',text),</span>
0132         <span class="comment">%    reg.mri2elec = zeros(4,4);</span>
0133         <span class="comment">%    for i=1:4,</span>
0134         <span class="comment">%        text = fgetl(fid);</span>
0135         <span class="comment">%        reg.mri2elec(i,:) = sscanf(text,'%f')';</span>
0136         <span class="comment">%    end</span>
0137         <span class="comment">%    % The emse matrix requires transposition</span>
0138         <span class="comment">%    reg.mri2elec = reg.mri2elec';</span>
0139         <span class="comment">%end</span>
0140         
0141         <span class="comment">% The coordinates of the three fiducials are given in both frames.</span>
0142         <span class="comment">% For example, Head lists the fiducial coordinates (taken from the</span>
0143         <span class="comment">% electrode data) in the head frame, while Head' are the fiducial</span>
0144         <span class="comment">% coordinates from the image data expressed in the head frame.</span>
0145         <span class="comment">% Similarly, Image lists the fiducial coordinates from the image</span>
0146         <span class="comment">% data in the image frame while Image' lists those from the electrode</span>
0147         <span class="comment">% data in the image frame. The two sets of numbers should be close but</span>
0148         <span class="comment">% not identical.</span>
0149         
0150         <span class="keyword">if</span> strmatch(<span class="string">'RPA'</span>,text,<span class="string">'exact'</span>),
0151             format = <span class="string">'%7c %f %f %f'</span>;
0152             <span class="comment">% Read the Right Preauricular coordinates</span>
0153             text = fgetl(fid);
0154             tmp = sscanf(text,format)';
0155             reg.RPA.Hh = tmp(8:10);
0156             text = fgetl(fid);
0157             tmp = sscanf(text,format)';
0158             reg.RPA.Mh = tmp(8:10);
0159             text = fgetl(fid);
0160             tmp = sscanf(text,format)';
0161             reg.RPA.Mm = tmp(8:10);
0162             text = fgetl(fid);
0163             tmp = sscanf(text,format)';
0164             reg.RPA.Hm = tmp(8:10);
0165         <span class="keyword">end</span>
0166         
0167         <span class="keyword">if</span> strmatch(<span class="string">'LPA'</span>,text,<span class="string">'exact'</span>),
0168             format = <span class="string">'%7c %f %f %f'</span>;
0169             <span class="comment">% Read the Left Preauricular coordinates</span>
0170             text = fgetl(fid);
0171             tmp = sscanf(text,format)';
0172             reg.LPA.Hh = tmp(8:10);
0173             text = fgetl(fid);
0174             tmp = sscanf(text,format)';
0175             reg.LPA.Mh = tmp(8:10);
0176             text = fgetl(fid);
0177             tmp = sscanf(text,format)';
0178             reg.LPA.Mm = tmp(8:10);
0179             text = fgetl(fid);
0180             tmp = sscanf(text,format)';
0181             reg.LPA.Hm = tmp(8:10);
0182         <span class="keyword">end</span>
0183         
0184         <span class="keyword">if</span> strmatch(<span class="string">'Nasion'</span>,text,<span class="string">'exact'</span>),
0185             format = <span class="string">'%7c %f %f %f'</span>;
0186             <span class="comment">% Read the Nasion coordinates</span>
0187             text = fgetl(fid);
0188             tmp = sscanf(text,format)';
0189             reg.NAS.Hh = tmp(8:10);
0190             text = fgetl(fid);
0191             tmp = sscanf(text,format)';
0192             reg.NAS.Mh = tmp(8:10);
0193             text = fgetl(fid);
0194             tmp = sscanf(text,format)';
0195             reg.NAS.Mm = tmp(8:10);
0196             text = fgetl(fid);
0197             tmp = sscanf(text,format)';
0198             reg.NAS.Hm = tmp(8:10);
0199         <span class="keyword">end</span>
0200         
0201         <span class="comment">% The Electrode Positions block lists the coordinates (x, y, and z)</span>
0202         <span class="comment">% first in the head frame and then in the image frame.</span>
0203         <span class="keyword">if</span> strmatch(<span class="string">'Electrode Positions'</span>,text),
0204             reg.Helec = zeros(1,3);
0205             reg.Melec = zeros(1,3);
0206             n = 1;
0207             <span class="keyword">while</span> n &lt; 400,
0208                 <span class="comment">% Read the Head space coordinates</span>
0209                 text = fgetl(fid);
0210                 <span class="keyword">if</span> isempty(text), <span class="keyword">break</span>; <span class="keyword">end</span>
0211                 tmp = sscanf(text,<span class="string">'%f : %f %f'</span>)';
0212                 reg.Helec(n,1:3) = tmp(2:4);
0213                 <span class="comment">% Read the MRI space coordinates</span>
0214                 text = fgetl(fid);
0215                 tmp = sscanf(text,<span class="string">'%s %f %f %f'</span>)';
0216                 reg.Melec(n,1:3) = tmp(2:4);
0217                 n = n + 1;
0218             <span class="keyword">end</span>
0219         <span class="keyword">end</span>
0220         
0221     <span class="keyword">end</span>
0222     
0223     <span class="comment">% Create essential fiducial marker matrices</span>
0224     <span class="comment">% The order of these points in the matrices is very</span>
0225     <span class="comment">% important if they are used for coregistration</span>
0226     reg.fiducials.head = [ reg.NAS.Hh; reg.RPA.Hh; reg.LPA.Hh ];
0227     reg.fiducials.mri  = [ reg.NAS.Mm; reg.RPA.Mm; reg.LPA.Mm ];
0228     
0229     
0230 <span class="keyword">return</span></pre></div>
<hr><address>Generated on Mon 29-Mar-2004 13:14:32 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/">m2html</a></strong> &copy; 2003</address>
</body>
</html>