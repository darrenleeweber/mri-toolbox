<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of avw_img_read</title>
  <meta name="keywords" content="avw_img_read">
  <meta name="description" content="avw_img_read - read Analyze format data image (*.img)">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">mri_toolbox</a> &gt; avw_img_read.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for mri_toolbox&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>avw_img_read
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>avw_img_read - read Analyze format data image (*.img)</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function [ avw, machine ] = avw_img_read(fileprefix,IMGorient,machine) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"> avw_img_read - read Analyze format data image (*.img)
 
 [ avw, machine ] = avw_img_read(fileprefix, [orient], [machine])
 
 fileprefix - a string, the filename without the .img extension
 
 orient - read a specified orientation, integer values:
 
          '', use header history orient field
          0,  transverse unflipped (LAS*)
          1,  coronal unflipped (LA*S)
          2,  sagittal unflipped (L*AS)
          3,  transverse flipped (LPS*)
          4,  coronal flipped (LA*I)
          5,  sagittal flipped (L*AI)
 
 where * follows the slice dimension and letters indicate +XYZ
 orientations (L left, R right, A anterior, P posterior,
 I inferior, &amp; S superior).
 
 Some files may contain data in the 3-5 orientations, but this
 is unlikely. For more information about orientation, see the
 documentation at the end of this .m file.  See also the
 <a href="avw_flip.html" class="code" title="function [ avw ] = avw_flip(avw,dims)">AVW_FLIP</a> function for orthogonal reorientation.

 machine - a string, see machineformat in fread for details.
           The default here is 'ieee-le' but the routine
           will automatically switch between little and big
           endian to read any such Analyze header.  It
           reports the appropriate machine format and can
           return the machine value.

 Returned values:

 avw.hdr - a struct with image data parameters.
 avw.img - a 3D matrix of image data (double precision).

 The returned 3D matrix will correspond with the
 default ANALYZE coordinate system, which
 is Left-handed:

 X-Y plane is Transverse
 X-Z plane is Coronal
 Y-Z plane is Sagittal

 X axis runs from patient right (low X) to patient Left (high X)
 Y axis runs from posterior (low Y) to Anterior (high Y)
 Z axis runs from inferior (low Z) to Superior (high Z)

 See also: <a href="avw_hdr_read.html" class="code" title="function [ avw, machine ] = avw_hdr_read(fileprefix, machine)">avw_hdr_read</a> (called by this function),
           <a href="avw_view.html" class="code" title="function [ varargout ] = avw_view(avw,parent,command),">avw_view</a>, <a href="avw_write.html" class="code" title="function avw_write(avw, fileprefix, IMGorient, machine)">avw_write</a>, <a href="avw_img_write.html" class="code" title="function avw_img_write(avw, fileprefix, IMGorient, machine)">avw_img_write</a>, <a href="avw_flip.html" class="code" title="function [ avw ] = avw_flip(avw,dims)">avw_flip</a></pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="avw_hdr_read.html" class="code" title="function [ avw, machine ] = avw_hdr_read(fileprefix, machine)">avw_hdr_read</a>	avw_hdr_read - read Analyze format data header (*.hdr)</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="avw_converter_script.html" class="code" title="">avw_converter_script</a>	avw_converter_script - convert byte order of .img files</li><li><a href="avw_img_compose.html" class="code" title="function avw = avw_img_compose(files,IMGorient,machine),">avw_img_compose</a>	AVW_IMG_COMPOSE - Compose single slice Analyze files into a volume</li><li><a href="avw_read.html" class="code" title="function [ avw, machine ] = avw_read(fileprefix,IMGorient,machine)">avw_read</a>	avw_read - read Analyze format data image (*.img)</li><li><a href="mesh_3shell_script.html" class="code" title="">mesh_3shell_script</a>	mesh_3shell_script</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="#_sub1" class="code">function [ avw ] = read_image(avw,IMGorient,machine)</a></li></ul>
<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [ avw, machine ] = avw_img_read(fileprefix,IMGorient,machine)</a>
0002 
0003 <span class="comment">% avw_img_read - read Analyze format data image (*.img)</span>
0004 <span class="comment">%</span>
0005 <span class="comment">% [ avw, machine ] = avw_img_read(fileprefix, [orient], [machine])</span>
0006 <span class="comment">%</span>
0007 <span class="comment">% fileprefix - a string, the filename without the .img extension</span>
0008 <span class="comment">%</span>
0009 <span class="comment">% orient - read a specified orientation, integer values:</span>
0010 <span class="comment">%</span>
0011 <span class="comment">%          '', use header history orient field</span>
0012 <span class="comment">%          0,  transverse unflipped (LAS*)</span>
0013 <span class="comment">%          1,  coronal unflipped (LA*S)</span>
0014 <span class="comment">%          2,  sagittal unflipped (L*AS)</span>
0015 <span class="comment">%          3,  transverse flipped (LPS*)</span>
0016 <span class="comment">%          4,  coronal flipped (LA*I)</span>
0017 <span class="comment">%          5,  sagittal flipped (L*AI)</span>
0018 <span class="comment">%</span>
0019 <span class="comment">% where * follows the slice dimension and letters indicate +XYZ</span>
0020 <span class="comment">% orientations (L left, R right, A anterior, P posterior,</span>
0021 <span class="comment">% I inferior, &amp; S superior).</span>
0022 <span class="comment">%</span>
0023 <span class="comment">% Some files may contain data in the 3-5 orientations, but this</span>
0024 <span class="comment">% is unlikely. For more information about orientation, see the</span>
0025 <span class="comment">% documentation at the end of this .m file.  See also the</span>
0026 <span class="comment">% AVW_FLIP function for orthogonal reorientation.</span>
0027 <span class="comment">%</span>
0028 <span class="comment">% machine - a string, see machineformat in fread for details.</span>
0029 <span class="comment">%           The default here is 'ieee-le' but the routine</span>
0030 <span class="comment">%           will automatically switch between little and big</span>
0031 <span class="comment">%           endian to read any such Analyze header.  It</span>
0032 <span class="comment">%           reports the appropriate machine format and can</span>
0033 <span class="comment">%           return the machine value.</span>
0034 <span class="comment">%</span>
0035 <span class="comment">% Returned values:</span>
0036 <span class="comment">%</span>
0037 <span class="comment">% avw.hdr - a struct with image data parameters.</span>
0038 <span class="comment">% avw.img - a 3D matrix of image data (double precision).</span>
0039 <span class="comment">%</span>
0040 <span class="comment">% The returned 3D matrix will correspond with the</span>
0041 <span class="comment">% default ANALYZE coordinate system, which</span>
0042 <span class="comment">% is Left-handed:</span>
0043 <span class="comment">%</span>
0044 <span class="comment">% X-Y plane is Transverse</span>
0045 <span class="comment">% X-Z plane is Coronal</span>
0046 <span class="comment">% Y-Z plane is Sagittal</span>
0047 <span class="comment">%</span>
0048 <span class="comment">% X axis runs from patient right (low X) to patient Left (high X)</span>
0049 <span class="comment">% Y axis runs from posterior (low Y) to Anterior (high Y)</span>
0050 <span class="comment">% Z axis runs from inferior (low Z) to Superior (high Z)</span>
0051 <span class="comment">%</span>
0052 <span class="comment">% See also: avw_hdr_read (called by this function),</span>
0053 <span class="comment">%           avw_view, avw_write, avw_img_write, avw_flip</span>
0054 <span class="comment">%</span>
0055 
0056 
0057 <span class="comment">% $Revision: 1.2 $ $Date: 2004/04/08 20:11:24 $</span>
0058 
0059 <span class="comment">% Licence:  GNU GPL, no express or implied warranties</span>
0060 <span class="comment">% History:  05/2002, Darren.Weber@flinders.edu.au</span>
0061 <span class="comment">%                    The Analyze format is copyright</span>
0062 <span class="comment">%                    (c) Copyright, 1986-1995</span>
0063 <span class="comment">%                    Biomedical Imaging Resource, Mayo Foundation</span>
0064 <span class="comment">%           01/2003, Darren.Weber@flinders.edu.au</span>
0065 <span class="comment">%                    - adapted for matlab v5</span>
0066 <span class="comment">%                    - revised all orientation information and handling</span>
0067 <span class="comment">%                      after seeking further advice from AnalyzeDirect.com</span>
0068 <span class="comment">%           03/2003, Darren.Weber@flinders.edu.au</span>
0069 <span class="comment">%                    - adapted for -ve pixdim values (non standard Analyze)</span>
0070 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0071 
0072 <span class="keyword">if</span> ~exist(<span class="string">'fileprefix'</span>,<span class="string">'var'</span>),
0073   msg = sprintf(<span class="string">'...no input fileprefix - see help avw_img_read\n\n'</span>);
0074   error(msg);
0075 <span class="keyword">end</span>
0076 <span class="keyword">if</span> ~exist(<span class="string">'IMGorient'</span>,<span class="string">'var'</span>), IMGorient = <span class="string">''</span>; <span class="keyword">end</span>
0077 <span class="keyword">if</span> ~exist(<span class="string">'machine'</span>,<span class="string">'var'</span>), machine = <span class="string">'ieee-le'</span>; <span class="keyword">end</span>
0078 
0079 <span class="keyword">if</span> findstr(<span class="string">'.hdr'</span>,fileprefix),
0080   fileprefix = strrep(fileprefix,<span class="string">'.hdr'</span>,<span class="string">''</span>);
0081 <span class="keyword">end</span>
0082 <span class="keyword">if</span> findstr(<span class="string">'.img'</span>,fileprefix),
0083   fileprefix = strrep(fileprefix,<span class="string">'.img'</span>,<span class="string">''</span>);
0084 <span class="keyword">end</span>
0085 
0086 <span class="comment">% MAIN</span>
0087 
0088 <span class="comment">% Read the file header</span>
0089 [ avw, machine ] = <a href="avw_hdr_read.html" class="code" title="function [ avw, machine ] = avw_hdr_read(fileprefix, machine)">avw_hdr_read</a>(fileprefix,machine);
0090 
0091 avw = <a href="#_sub1" class="code" title="subfunction [ avw ] = read_image(avw,IMGorient,machine)">read_image</a>(avw,IMGorient,machine);
0092 
0093 <span class="keyword">return</span>
0094 
0095 
0096 
0097 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0098 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0099 <a name="_sub1" href="#_subfunctions" class="code">function [ avw ] = read_image(avw,IMGorient,machine)</a>
0100 
0101 fid = fopen(sprintf(<span class="string">'%s.img'</span>,avw.fileprefix),<span class="string">'r'</span>,machine);
0102 <span class="keyword">if</span> fid &lt; 0,
0103   msg = sprintf(<span class="string">'...cannot open file %s.img\n\n'</span>,avw.fileprefix);
0104   error(msg);
0105 <span class="keyword">end</span>
0106 
0107 ver = <span class="string">'[$Revision: 1.2 $]'</span>;
0108 fprintf(<span class="string">'\nAVW_IMG_READ [v%s]\n'</span>,ver(12:16));  tic;
0109 
0110 <span class="comment">% short int bitpix;    /* Number of bits per pixel; 1, 8, 16, 32, or 64. */</span>
0111 <span class="comment">% short int datatype      /* Datatype for this image set */</span>
0112 <span class="comment">% /*Acceptable values for datatype are*/</span>
0113 <span class="comment">% #define DT_NONE             0</span>
0114 <span class="comment">% #define DT_UNKNOWN          0    /*Unknown data type*/</span>
0115 <span class="comment">% #define DT_BINARY           1    /*Binary             ( 1 bit per voxel)*/</span>
0116 <span class="comment">% #define DT_UNSIGNED_CHAR    2    /*Unsigned character ( 8 bits per voxel)*/</span>
0117 <span class="comment">% #define DT_SIGNED_SHORT     4    /*Signed short       (16 bits per voxel)*/</span>
0118 <span class="comment">% #define DT_SIGNED_INT       8    /*Signed integer     (32 bits per voxel)*/</span>
0119 <span class="comment">% #define DT_FLOAT           16    /*Floating point     (32 bits per voxel)*/</span>
0120 <span class="comment">% #define DT_COMPLEX         32    /*Complex (64 bits per voxel; 2 floating point numbers)/*</span>
0121 <span class="comment">% #define DT_DOUBLE          64    /*Double precision   (64 bits per voxel)*/</span>
0122 <span class="comment">% #define DT_RGB            128    /*A Red-Green-Blue datatype*/</span>
0123 <span class="comment">% #define DT_ALL            255    /*Undocumented*/</span>
0124 
0125 <span class="keyword">switch</span> double(avw.hdr.dime.bitpix),
0126   <span class="keyword">case</span>  1,   precision = <span class="string">'bit1'</span>;
0127   <span class="keyword">case</span>  8,   precision = <span class="string">'uchar'</span>;
0128   <span class="keyword">case</span> 16,   precision = <span class="string">'int16'</span>;
0129   <span class="keyword">case</span> 32,
0130     <span class="keyword">if</span>     isequal(avw.hdr.dime.datatype, 8), precision = <span class="string">'int32'</span>;
0131     <span class="keyword">else</span>                                      precision = <span class="string">'single'</span>;
0132     <span class="keyword">end</span>
0133   <span class="keyword">case</span> 64,   precision = <span class="string">'double'</span>;
0134   <span class="keyword">otherwise</span>,
0135     precision = <span class="string">'uchar'</span>;
0136     fprintf(<span class="string">'...precision undefined in header, using ''uchar''\n'</span>);
0137 <span class="keyword">end</span>
0138 
0139 <span class="comment">% read the whole .img file into matlab (faster)</span>
0140 fprintf(<span class="string">'...reading %s Analyze %s image format.\n'</span>,machine,precision);
0141 fseek(fid,0,<span class="string">'bof'</span>);
0142 <span class="comment">% adjust for matlab version</span>
0143 ver = version;
0144 ver = str2num(ver(1));
0145 <span class="keyword">if</span> ver &lt; 6,
0146   tmp = fread(fid,inf,sprintf(<span class="string">'%s'</span>,precision));
0147 <span class="keyword">else</span>,
0148   tmp = fread(fid,inf,sprintf(<span class="string">'%s=&gt;double'</span>,precision));
0149 <span class="keyword">end</span>
0150 fclose(fid);
0151 
0152 <span class="comment">% Update the global min and max values</span>
0153 avw.hdr.dime.glmax = max(double(tmp));
0154 avw.hdr.dime.glmin = min(double(tmp));
0155 
0156 
0157 <span class="comment">%---------------------------------------------------------------</span>
0158 <span class="comment">% Now partition the img data into xyz</span>
0159 
0160 <span class="comment">% --- first figure out the size of the image</span>
0161 
0162 <span class="comment">% short int dim[ ];      /* Array of the image dimensions */</span>
0163 <span class="comment">%</span>
0164 <span class="comment">% dim[0]      Number of dimensions in database; usually 4.</span>
0165 <span class="comment">% dim[1]      Image X dimension;  number of pixels in an image row.</span>
0166 <span class="comment">% dim[2]      Image Y dimension;  number of pixel rows in slice.</span>
0167 <span class="comment">% dim[3]      Volume Z dimension; number of slices in a volume.</span>
0168 <span class="comment">% dim[4]      Time points; number of volumes in database.</span>
0169 
0170 PixelDim = double(avw.hdr.dime.dim(2));
0171 RowDim   = double(avw.hdr.dime.dim(3));
0172 SliceDim = double(avw.hdr.dime.dim(4));
0173 
0174 PixelSz  = double(avw.hdr.dime.pixdim(2));
0175 RowSz    = double(avw.hdr.dime.pixdim(3));
0176 SliceSz  = double(avw.hdr.dime.pixdim(4));
0177 
0178 
0179 
0180 
0181 
0182 <span class="comment">% ---- NON STANDARD ANALYZE...</span>
0183 
0184 <span class="comment">% Some Analyze files have been found to set -ve pixdim values, eg</span>
0185 <span class="comment">% the MNI template avg152T1_brain in the FSL etc/standard folder,</span>
0186 <span class="comment">% perhaps to indicate flipped orientation?  If so, this code below</span>
0187 <span class="comment">% will NOT handle the flip correctly!</span>
0188 <span class="keyword">if</span> PixelSz &lt; 0,
0189   warning(<span class="string">'X pixdim &lt; 0 !!! resetting to abs(avw.hdr.dime.pixdim(2))'</span>);
0190   PixelSz = abs(PixelSz);
0191   avw.hdr.dime.pixdim(2) = single(PixelSz);
0192 <span class="keyword">end</span>
0193 <span class="keyword">if</span> RowSz &lt; 0,
0194   warning(<span class="string">'Y pixdim &lt; 0 !!! resetting to abs(avw.hdr.dime.pixdim(3))'</span>);
0195   RowSz = abs(RowSz);
0196   avw.hdr.dime.pixdim(3) = single(RowSz);
0197 <span class="keyword">end</span>
0198 <span class="keyword">if</span> SliceSz &lt; 0,
0199   warning(<span class="string">'Z pixdim &lt; 0 !!! resetting to abs(avw.hdr.dime.pixdim(4))'</span>);
0200   SliceSz = abs(SliceSz);
0201   avw.hdr.dime.pixdim(4) = single(SliceSz);
0202 <span class="keyword">end</span>
0203 
0204 <span class="comment">% ---- END OF NON STANDARD ANALYZE</span>
0205 
0206 
0207 
0208 
0209 
0210 <span class="comment">% --- check the orientation specification and arrange img accordingly</span>
0211 <span class="keyword">if</span> ~isempty(IMGorient),
0212   <span class="keyword">if</span> ischar(IMGorient),
0213     avw.hdr.hist.orient = uint8(str2num(IMGorient));
0214   <span class="keyword">else</span>
0215     avw.hdr.hist.orient = uint8(IMGorient);
0216   <span class="keyword">end</span>
0217 <span class="keyword">end</span>,
0218 
0219 <span class="keyword">if</span> isempty(avw.hdr.hist.orient),
0220   msg = [ <span class="string">'...unspecified avw.hdr.hist.orient, using default 0\n'</span>,<span class="keyword">...</span>
0221       <span class="string">'   (check image and try explicit IMGorient option).\n'</span>];
0222   fprintf(msg);
0223   avw.hdr.hist.orient = uint8(0);
0224 <span class="keyword">end</span>
0225 
0226 <span class="keyword">switch</span> double(avw.hdr.hist.orient),
0227   
0228   <span class="keyword">case</span> 0, <span class="comment">% transverse unflipped</span>
0229     
0230     <span class="comment">% orient = 0:  The primary orientation of the data on disk is in the</span>
0231     <span class="comment">% transverse plane relative to the object scanned.  Most commonly, the fastest</span>
0232     <span class="comment">% moving index through the voxels that are part of this transverse image would</span>
0233     <span class="comment">% span the right-left extent of the structure imaged, with the next fastest</span>
0234     <span class="comment">% moving index spanning the posterior-anterior extent of the structure.  This</span>
0235     <span class="comment">% 'orient' flag would indicate to Analyze that this data should be placed in</span>
0236     <span class="comment">% the X-Y plane of the 3D Analyze Coordinate System, with the Z dimension</span>
0237     <span class="comment">% being the slice direction.</span>
0238     
0239     <span class="comment">% For the 'transverse unflipped' type, the voxels are stored with</span>
0240     <span class="comment">% Pixels in 'x' axis (varies fastest) - from patient right to left</span>
0241     <span class="comment">% Rows in   'y' axis                  - from patient posterior to anterior</span>
0242     <span class="comment">% Slices in 'z' axis                  - from patient inferior to superior</span>
0243     
0244     fprintf(<span class="string">'...reading axial unflipped orientation\n'</span>);
0245     
0246     avw.img = zeros(PixelDim,RowDim,SliceDim);
0247     
0248     n = 1;
0249     x = 1:PixelDim;
0250     <span class="keyword">for</span> z = 1:SliceDim,
0251       <span class="keyword">for</span> y = 1:RowDim,
0252         <span class="comment">% load Y row of X values into Z slice avw.img</span>
0253         avw.img(x,y,z) = tmp(n:n+(PixelDim-1));
0254         n = n + PixelDim;
0255       <span class="keyword">end</span>
0256     <span class="keyword">end</span>
0257     
0258     <span class="comment">% no need to rearrange avw.hdr.dime.dim or avw.hdr.dime.pixdim</span>
0259     
0260     
0261   <span class="keyword">case</span> 1, <span class="comment">% coronal unflipped</span>
0262     
0263     <span class="comment">% orient = 1:  The primary orientation of the data on disk is in the coronal</span>
0264     <span class="comment">% plane relative to the object scanned.  Most commonly, the fastest moving</span>
0265     <span class="comment">% index through the voxels that are part of this coronal image would span the</span>
0266     <span class="comment">% right-left extent of the structure imaged, with the next fastest moving</span>
0267     <span class="comment">% index spanning the inferior-superior extent of the structure.  This 'orient'</span>
0268     <span class="comment">% flag would indicate to Analyze that this data should be placed in the X-Z</span>
0269     <span class="comment">% plane of the 3D Analyze Coordinate System, with the Y dimension being the</span>
0270     <span class="comment">% slice direction.</span>
0271     
0272     <span class="comment">% For the 'coronal unflipped' type, the voxels are stored with</span>
0273     <span class="comment">% Pixels in 'x' axis (varies fastest) - from patient right to left</span>
0274     <span class="comment">% Rows in   'z' axis                  - from patient inferior to superior</span>
0275     <span class="comment">% Slices in 'y' axis                  - from patient posterior to anterior</span>
0276     
0277     fprintf(<span class="string">'...reading coronal unflipped orientation\n'</span>);
0278     
0279     avw.img = zeros(PixelDim,SliceDim,RowDim);
0280     
0281     n = 1;
0282     x = 1:PixelDim;
0283     <span class="keyword">for</span> y = 1:SliceDim,
0284       <span class="keyword">for</span> z = 1:RowDim,
0285         <span class="comment">% load Z row of X values into Y slice avw.img</span>
0286         avw.img(x,y,z) = tmp(n:n+(PixelDim-1));
0287         n = n + PixelDim;
0288       <span class="keyword">end</span>
0289     <span class="keyword">end</span>
0290     
0291     <span class="comment">% rearrange avw.hdr.dime.dim or avw.hdr.dime.pixdim</span>
0292     avw.hdr.dime.dim(2:4) = int16([PixelDim,SliceDim,RowDim]);
0293     avw.hdr.dime.pixdim(2:4) = single([PixelSz,SliceSz,RowSz]);
0294     
0295     
0296   <span class="keyword">case</span> 2, <span class="comment">% sagittal unflipped</span>
0297     
0298     <span class="comment">% orient = 2:  The primary orientation of the data on disk is in the sagittal</span>
0299     <span class="comment">% plane relative to the object scanned.  Most commonly, the fastest moving</span>
0300     <span class="comment">% index through the voxels that are part of this sagittal image would span the</span>
0301     <span class="comment">% posterior-anterior extent of the structure imaged, with the next fastest</span>
0302     <span class="comment">% moving index spanning the inferior-superior extent of the structure.  This</span>
0303     <span class="comment">% 'orient' flag would indicate to Analyze that this data should be placed in</span>
0304     <span class="comment">% the Y-Z plane of the 3D Analyze Coordinate System, with the X dimension</span>
0305     <span class="comment">% being the slice direction.</span>
0306     
0307     <span class="comment">% For the 'sagittal unflipped' type, the voxels are stored with</span>
0308     <span class="comment">% Pixels in 'y' axis (varies fastest) - from patient posterior to anterior</span>
0309     <span class="comment">% Rows in   'z' axis                  - from patient inferior to superior</span>
0310     <span class="comment">% Slices in 'x' axis                  - from patient right to left</span>
0311     
0312     fprintf(<span class="string">'...reading sagittal unflipped orientation\n'</span>);
0313     
0314     avw.img = zeros(SliceDim,PixelDim,RowDim);
0315     
0316     n = 1;
0317     y = 1:PixelDim;         <span class="comment">% posterior to anterior (fastest)</span>
0318     
0319     <span class="keyword">for</span> x = 1:SliceDim,     <span class="comment">% right to left (slowest)</span>
0320       <span class="keyword">for</span> z = 1:RowDim,   <span class="comment">% inferior to superior</span>
0321         
0322         <span class="comment">% load Z row of Y values into X slice avw.img</span>
0323         avw.img(x,y,z) = tmp(n:n+(PixelDim-1));
0324         n = n + PixelDim;
0325       <span class="keyword">end</span>
0326     <span class="keyword">end</span>
0327     
0328     <span class="comment">% rearrange avw.hdr.dime.dim or avw.hdr.dime.pixdim</span>
0329     avw.hdr.dime.dim(2:4) = int16([SliceDim,PixelDim,RowDim]);
0330     avw.hdr.dime.pixdim(2:4) = single([SliceSz,PixelSz,RowSz]);
0331     
0332     
0333     <span class="comment">%--------------------------------------------------------------------------------</span>
0334     <span class="comment">% Orient values 3-5 have the second index reversed in order, essentially</span>
0335     <span class="comment">% 'flipping' the images relative to what would most likely become the vertical</span>
0336     <span class="comment">% axis of the displayed image.</span>
0337     <span class="comment">%--------------------------------------------------------------------------------</span>
0338     
0339   <span class="keyword">case</span> 3, <span class="comment">% transverse/axial flipped</span>
0340     
0341     <span class="comment">% orient = 3:  The primary orientation of the data on disk is in the</span>
0342     <span class="comment">% transverse plane relative to the object scanned.  Most commonly, the fastest</span>
0343     <span class="comment">% moving index through the voxels that are part of this transverse image would</span>
0344     <span class="comment">% span the right-left extent of the structure imaged, with the next fastest</span>
0345     <span class="comment">% moving index spanning the *anterior-posterior* extent of the structure.  This</span>
0346     <span class="comment">% 'orient' flag would indicate to Analyze that this data should be placed in</span>
0347     <span class="comment">% the X-Y plane of the 3D Analyze Coordinate System, with the Z dimension</span>
0348     <span class="comment">% being the slice direction.</span>
0349     
0350     <span class="comment">% For the 'transverse flipped' type, the voxels are stored with</span>
0351     <span class="comment">% Pixels in 'x' axis (varies fastest) - from patient right to Left</span>
0352     <span class="comment">% Rows in   'y' axis                  - from patient anterior to Posterior *</span>
0353     <span class="comment">% Slices in 'z' axis                  - from patient inferior to Superior</span>
0354     
0355     fprintf(<span class="string">'...reading axial flipped (+Y from Anterior to Posterior)\n'</span>);
0356     
0357     avw.img = zeros(PixelDim,RowDim,SliceDim);
0358     
0359     n = 1;
0360     x = 1:PixelDim;
0361     <span class="keyword">for</span> z = 1:SliceDim,
0362       <span class="keyword">for</span> y = RowDim:-1:1, <span class="comment">% flip in Y, read A2P file into P2A 3D matrix</span>
0363         
0364         <span class="comment">% load a flipped Y row of X values into Z slice avw.img</span>
0365         avw.img(x,y,z) = tmp(n:n+(PixelDim-1));
0366         n = n + PixelDim;
0367       <span class="keyword">end</span>
0368     <span class="keyword">end</span>
0369     
0370     <span class="comment">% no need to rearrange avw.hdr.dime.dim or avw.hdr.dime.pixdim</span>
0371     
0372     
0373   <span class="keyword">case</span> 4, <span class="comment">% coronal flipped</span>
0374     
0375     <span class="comment">% orient = 4:  The primary orientation of the data on disk is in the coronal</span>
0376     <span class="comment">% plane relative to the object scanned.  Most commonly, the fastest moving</span>
0377     <span class="comment">% index through the voxels that are part of this coronal image would span the</span>
0378     <span class="comment">% right-left extent of the structure imaged, with the next fastest moving</span>
0379     <span class="comment">% index spanning the *superior-inferior* extent of the structure.  This 'orient'</span>
0380     <span class="comment">% flag would indicate to Analyze that this data should be placed in the X-Z</span>
0381     <span class="comment">% plane of the 3D Analyze Coordinate System, with the Y dimension being the</span>
0382     <span class="comment">% slice direction.</span>
0383     
0384     <span class="comment">% For the 'coronal flipped' type, the voxels are stored with</span>
0385     <span class="comment">% Pixels in 'x' axis (varies fastest) - from patient right to Left</span>
0386     <span class="comment">% Rows in   'z' axis                  - from patient superior to Inferior*</span>
0387     <span class="comment">% Slices in 'y' axis                  - from patient posterior to Anterior</span>
0388     
0389     fprintf(<span class="string">'...reading coronal flipped (+Z from Superior to Inferior)\n'</span>);
0390     
0391     avw.img = zeros(PixelDim,SliceDim,RowDim);
0392     
0393     n = 1;
0394     x = 1:PixelDim;
0395     <span class="keyword">for</span> y = 1:SliceDim,
0396       <span class="keyword">for</span> z = RowDim:-1:1, <span class="comment">% flip in Z, read S2I file into I2S 3D matrix</span>
0397         
0398         <span class="comment">% load a flipped Z row of X values into Y slice avw.img</span>
0399         avw.img(x,y,z) = tmp(n:n+(PixelDim-1));
0400         n = n + PixelDim;
0401       <span class="keyword">end</span>
0402     <span class="keyword">end</span>
0403     
0404     <span class="comment">% rearrange avw.hdr.dime.dim or avw.hdr.dime.pixdim</span>
0405     avw.hdr.dime.dim(2:4) = int16([PixelDim,SliceDim,RowDim]);
0406     avw.hdr.dime.pixdim(2:4) = single([PixelSz,SliceSz,RowSz]);
0407     
0408     
0409   <span class="keyword">case</span> 5, <span class="comment">% sagittal flipped</span>
0410     
0411     <span class="comment">% orient = 5:  The primary orientation of the data on disk is in the sagittal</span>
0412     <span class="comment">% plane relative to the object scanned.  Most commonly, the fastest moving</span>
0413     <span class="comment">% index through the voxels that are part of this sagittal image would span the</span>
0414     <span class="comment">% posterior-anterior extent of the structure imaged, with the next fastest</span>
0415     <span class="comment">% moving index spanning the *superior-inferior* extent of the structure.  This</span>
0416     <span class="comment">% 'orient' flag would indicate to Analyze that this data should be placed in</span>
0417     <span class="comment">% the Y-Z plane of the 3D Analyze Coordinate System, with the X dimension</span>
0418     <span class="comment">% being the slice direction.</span>
0419     
0420     <span class="comment">% For the 'sagittal flipped' type, the voxels are stored with</span>
0421     <span class="comment">% Pixels in 'y' axis (varies fastest) - from patient posterior to Anterior</span>
0422     <span class="comment">% Rows in   'z' axis                  - from patient superior to Inferior*</span>
0423     <span class="comment">% Slices in 'x' axis                  - from patient right to Left</span>
0424     
0425     fprintf(<span class="string">'...reading sagittal flipped (+Z from Superior to Inferior)\n'</span>);
0426     
0427     avw.img = zeros(SliceDim,PixelDim,RowDim);
0428     
0429     n = 1;
0430     y = 1:PixelDim;
0431     
0432     <span class="keyword">for</span> x = 1:SliceDim,
0433       <span class="keyword">for</span> z = RowDim:-1:1, <span class="comment">% flip in Z, read S2I file into I2S 3D matrix</span>
0434         
0435         <span class="comment">% load a flipped Z row of Y values into X slice avw.img</span>
0436         avw.img(x,y,z) = tmp(n:n+(PixelDim-1));
0437         n = n + PixelDim;
0438       <span class="keyword">end</span>
0439     <span class="keyword">end</span>
0440     
0441     <span class="comment">% rearrange avw.hdr.dime.dim or avw.hdr.dime.pixdim</span>
0442     avw.hdr.dime.dim(2:4) = int16([SliceDim,PixelDim,RowDim]);
0443     avw.hdr.dime.pixdim(2:4) = single([SliceSz,PixelSz,RowSz]);
0444     
0445   <span class="keyword">otherwise</span>
0446     
0447     error(<span class="string">'unknown value in avw.hdr.hist.orient, try explicit IMGorient option.'</span>);
0448     
0449 <span class="keyword">end</span>
0450 
0451 t=toc; fprintf(<span class="string">'...done (%5.2f sec).\n\n'</span>,t);
0452 
0453 <span class="keyword">return</span>
0454 
0455 
0456 
0457 
0458 <span class="comment">% This function attempts to read the orientation of the</span>
0459 <span class="comment">% Analyze file according to the hdr.hist.orient field of the</span>
0460 <span class="comment">% header.  Unfortunately, this field is optional and not</span>
0461 <span class="comment">% all programs will set it correctly, so there is no guarantee,</span>
0462 <span class="comment">% that the data loaded will be correctly oriented.  If necessary,</span>
0463 <span class="comment">% experiment with the 'orient' option to read the .img</span>
0464 <span class="comment">% data into the 3D matrix of avw.img as preferred.</span>
0465 <span class="comment">%</span>
0466 
0467 <span class="comment">% (Conventions gathered from e-mail with support@AnalyzeDirect.com)</span>
0468 <span class="comment">%</span>
0469 <span class="comment">% 0  transverse unflipped</span>
0470 <span class="comment">%       X direction first,  progressing from patient right to left,</span>
0471 <span class="comment">%       Y direction second, progressing from patient posterior to anterior,</span>
0472 <span class="comment">%       Z direction third,  progressing from patient inferior to superior.</span>
0473 <span class="comment">% 1  coronal unflipped</span>
0474 <span class="comment">%       X direction first,  progressing from patient right to left,</span>
0475 <span class="comment">%       Z direction second, progressing from patient inferior to superior,</span>
0476 <span class="comment">%       Y direction third,  progressing from patient posterior to anterior.</span>
0477 <span class="comment">% 2  sagittal unflipped</span>
0478 <span class="comment">%       Y direction first,  progressing from patient posterior to anterior,</span>
0479 <span class="comment">%       Z direction second, progressing from patient inferior to superior,</span>
0480 <span class="comment">%       X direction third,  progressing from patient right to left.</span>
0481 <span class="comment">% 3  transverse flipped</span>
0482 <span class="comment">%       X direction first,  progressing from patient right to left,</span>
0483 <span class="comment">%       Y direction second, progressing from patient anterior to posterior,</span>
0484 <span class="comment">%       Z direction third,  progressing from patient inferior to superior.</span>
0485 <span class="comment">% 4  coronal flipped</span>
0486 <span class="comment">%       X direction first,  progressing from patient right to left,</span>
0487 <span class="comment">%       Z direction second, progressing from patient superior to inferior,</span>
0488 <span class="comment">%       Y direction third,  progressing from patient posterior to anterior.</span>
0489 <span class="comment">% 5  sagittal flipped</span>
0490 <span class="comment">%       Y direction first,  progressing from patient posterior to anterior,</span>
0491 <span class="comment">%       Z direction second, progressing from patient superior to inferior,</span>
0492 <span class="comment">%       X direction third,  progressing from patient right to left.</span>
0493 
0494 
0495 <span class="comment">%----------------------------------------------------------------------------</span>
0496 <span class="comment">% From ANALYZE documentation...</span>
0497 <span class="comment">%</span>
0498 <span class="comment">% The ANALYZE coordinate system has an origin in the lower left</span>
0499 <span class="comment">% corner. That is, with the subject lying supine, the coordinate</span>
0500 <span class="comment">% origin is on the right side of the body (x), at the back (y),</span>
0501 <span class="comment">% and at the feet (z). This means that:</span>
0502 <span class="comment">%</span>
0503 <span class="comment">% +X increases from right (R) to left (L)</span>
0504 <span class="comment">% +Y increases from the back (posterior,P) to the front (anterior, A)</span>
0505 <span class="comment">% +Z increases from the feet (inferior,I) to the head (superior, S)</span>
0506 <span class="comment">%</span>
0507 <span class="comment">% The LAS orientation is the radiological convention, where patient</span>
0508 <span class="comment">% left is on the image right.  The alternative neurological</span>
0509 <span class="comment">% convention is RAS (also Talairach convention).</span>
0510 <span class="comment">%</span>
0511 <span class="comment">% A major advantage of the Analzye origin convention is that the</span>
0512 <span class="comment">% coordinate origin of each orthogonal orientation (transverse,</span>
0513 <span class="comment">% coronal, and sagittal) lies in the lower left corner of the</span>
0514 <span class="comment">% slice as it is displayed.</span>
0515 <span class="comment">%</span>
0516 <span class="comment">% Orthogonal slices are numbered from one to the number of slices</span>
0517 <span class="comment">% in that orientation. For example, a volume (x, y, z) dimensioned</span>
0518 <span class="comment">% 128, 256, 48 has:</span>
0519 <span class="comment">%</span>
0520 <span class="comment">%   128 sagittal   slices numbered 1 through 128 (X)</span>
0521 <span class="comment">%   256 coronal    slices numbered 1 through 256 (Y)</span>
0522 <span class="comment">%    48 transverse slices numbered 1 through  48 (Z)</span>
0523 <span class="comment">%</span>
0524 <span class="comment">% Pixel coordinates are made with reference to the slice numbers from</span>
0525 <span class="comment">% which the pixels come. Thus, the first pixel in the volume is</span>
0526 <span class="comment">% referenced p(1,1,1) and not at p(0,0,0).</span>
0527 <span class="comment">%</span>
0528 <span class="comment">% Transverse slices are in the XY plane (also known as axial slices).</span>
0529 <span class="comment">% Sagittal slices are in the ZY plane.</span>
0530 <span class="comment">% Coronal slices are in the ZX plane.</span>
0531 <span class="comment">%</span>
0532 <span class="comment">%----------------------------------------------------------------------------</span>
0533 
0534 
0535 <span class="comment">%----------------------------------------------------------------------------</span>
0536 <span class="comment">% E-mail from support@AnalyzeDirect.com</span>
0537 <span class="comment">%</span>
0538 <span class="comment">% The 'orient' field in the data_history structure specifies the primary</span>
0539 <span class="comment">% orientation of the data as it is stored in the file on disk.  This usually</span>
0540 <span class="comment">% corresponds to the orientation in the plane of acquisition, given that this</span>
0541 <span class="comment">% would correspond to the order in which the data is written to disk by the</span>
0542 <span class="comment">% scanner or other software application.  As you know, this field will contain</span>
0543 <span class="comment">% the values:</span>
0544 <span class="comment">%</span>
0545 <span class="comment">% orient = 0 transverse unflipped</span>
0546 <span class="comment">% 1 coronal unflipped</span>
0547 <span class="comment">% 2 sagittal unflipped</span>
0548 <span class="comment">% 3 transverse flipped</span>
0549 <span class="comment">% 4 coronal flipped</span>
0550 <span class="comment">% 5 sagittal flipped</span>
0551 <span class="comment">%</span>
0552 <span class="comment">% It would be vary rare that you would ever encounter any old Analyze 7.5</span>
0553 <span class="comment">% files that contain values of 'orient' which indicate that the data has been</span>
0554 <span class="comment">% 'flipped'.  The 'flipped flag' values were really only used internal to</span>
0555 <span class="comment">% Analyze to precondition data for fast display in the Movie module, where the</span>
0556 <span class="comment">% images were actually flipped vertically in order to accommodate the raster</span>
0557 <span class="comment">% paint order on older graphics devices.  The only cases you will encounter</span>
0558 <span class="comment">% will have values of 0, 1, or 2.</span>
0559 <span class="comment">%</span>
0560 <span class="comment">% As mentioned, the 'orient' flag only specifies the primary orientation of</span>
0561 <span class="comment">% data as stored in the disk file itself.  It has nothing to do with the</span>
0562 <span class="comment">% representation of the data in the 3D Analyze coordinate system, which always</span>
0563 <span class="comment">% has a fixed representation to the data.  The meaning of the 'orient' values</span>
0564 <span class="comment">% should be interpreted as follows:</span>
0565 <span class="comment">%</span>
0566 <span class="comment">% orient = 0:  The primary orientation of the data on disk is in the</span>
0567 <span class="comment">% transverse plane relative to the object scanned.  Most commonly, the fastest</span>
0568 <span class="comment">% moving index through the voxels that are part of this transverse image would</span>
0569 <span class="comment">% span the right-left extent of the structure imaged, with the next fastest</span>
0570 <span class="comment">% moving index spanning the posterior-anterior extent of the structure.  This</span>
0571 <span class="comment">% 'orient' flag would indicate to Analyze that this data should be placed in</span>
0572 <span class="comment">% the X-Y plane of the 3D Analyze Coordinate System, with the Z dimension</span>
0573 <span class="comment">% being the slice direction.</span>
0574 <span class="comment">%</span>
0575 <span class="comment">% orient = 1:  The primary orientation of the data on disk is in the coronal</span>
0576 <span class="comment">% plane relative to the object scanned.  Most commonly, the fastest moving</span>
0577 <span class="comment">% index through the voxels that are part of this coronal image would span the</span>
0578 <span class="comment">% right-left extent of the structure imaged, with the next fastest moving</span>
0579 <span class="comment">% index spanning the inferior-superior extent of the structure.  This 'orient'</span>
0580 <span class="comment">% flag would indicate to Analyze that this data should be placed in the X-Z</span>
0581 <span class="comment">% plane of the 3D Analyze Coordinate System, with the Y dimension being the</span>
0582 <span class="comment">% slice direction.</span>
0583 <span class="comment">%</span>
0584 <span class="comment">% orient = 2:  The primary orientation of the data on disk is in the sagittal</span>
0585 <span class="comment">% plane relative to the object scanned.  Most commonly, the fastest moving</span>
0586 <span class="comment">% index through the voxels that are part of this sagittal image would span the</span>
0587 <span class="comment">% posterior-anterior extent of the structure imaged, with the next fastest</span>
0588 <span class="comment">% moving index spanning the inferior-superior extent of the structure.  This</span>
0589 <span class="comment">% 'orient' flag would indicate to Analyze that this data should be placed in</span>
0590 <span class="comment">% the Y-Z plane of the 3D Analyze Coordinate System, with the X dimension</span>
0591 <span class="comment">% being the slice direction.</span>
0592 <span class="comment">%</span>
0593 <span class="comment">% Orient values 3-5 have the second index reversed in order, essentially</span>
0594 <span class="comment">% 'flipping' the images relative to what would most likely become the vertical</span>
0595 <span class="comment">% axis of the displayed image.</span>
0596 <span class="comment">%</span>
0597 <span class="comment">% Hopefully you understand the difference between the indication this 'orient'</span>
0598 <span class="comment">% flag has relative to data stored on disk and the full 3D Analyze Coordinate</span>
0599 <span class="comment">% System for data that is managed as a volume image.  As mentioned previously,</span>
0600 <span class="comment">% the orientation of patient anatomy in the 3D Analyze Coordinate System has a</span>
0601 <span class="comment">% fixed orientation relative to each of the orthogonal axes.  This orientation</span>
0602 <span class="comment">% is completely described in the information that is attached, but the basics</span>
0603 <span class="comment">% are:</span>
0604 <span class="comment">%</span>
0605 <span class="comment">% Left-handed coordinate system</span>
0606 <span class="comment">%</span>
0607 <span class="comment">% X-Y plane is Transverse</span>
0608 <span class="comment">% X-Z plane is Coronal</span>
0609 <span class="comment">% Y-Z plane is Sagittal</span>
0610 <span class="comment">%</span>
0611 <span class="comment">% X axis runs from patient right (low X) to patient left (high X)</span>
0612 <span class="comment">% Y axis runs from posterior (low Y) to anterior (high Y)</span>
0613 <span class="comment">% Z axis runs from inferior (low Z) to superior (high Z)</span>
0614 <span class="comment">%</span>
0615 <span class="comment">%----------------------------------------------------------------------------</span>
0616 
0617 
0618 
0619 <span class="comment">%----------------------------------------------------------------------------</span>
0620 <span class="comment">% SPM2 NOTES from spm2 webpage: One thing to watch out for is the image</span>
0621 <span class="comment">% orientation. The proper Analyze format uses a left-handed co-ordinate</span>
0622 <span class="comment">% system, whereas Talairach uses a right-handed one. In SPM99, images were</span>
0623 <span class="comment">% flipped at the spatial normalisation stage (from one co-ordinate system</span>
0624 <span class="comment">% to the other). In SPM2b, a different approach is used, so that either a</span>
0625 <span class="comment">% left- or right-handed co-ordinate system is used throughout. The SPM2b</span>
0626 <span class="comment">% program is told about the handedness that the images are stored with by</span>
0627 <span class="comment">% the spm_flip_analyze_images.m function and the defaults.analyze.flip</span>
0628 <span class="comment">% parameter that is specified in the spm_defaults.m file. These files are</span>
0629 <span class="comment">% intended to be customised for each site. If you previously used SPM99</span>
0630 <span class="comment">% and your images were flipped during spatial normalisation, then set</span>
0631 <span class="comment">% defaults.analyze.flip=1. If no flipping took place, then set</span>
0632 <span class="comment">% defaults.analyze.flip=0. Check that when using the Display facility</span>
0633 <span class="comment">% (possibly after specifying some rigid-body rotations) that:</span>
0634 <span class="comment">%</span>
0635 <span class="comment">% The top-left image is coronal with the top (superior) of the head displayed</span>
0636 <span class="comment">% at the top and the left shown on the left. This is as if the subject is viewed</span>
0637 <span class="comment">% from behind.</span>
0638 <span class="comment">%</span>
0639 <span class="comment">% The bottom-left image is axial with the front (anterior) of the head at the</span>
0640 <span class="comment">% top and the left shown on the left. This is as if the subject is viewed from above.</span>
0641 <span class="comment">%</span>
0642 <span class="comment">% The top-right image is sagittal with the front (anterior) of the head at the</span>
0643 <span class="comment">% left and the top of the head shown at the top. This is as if the subject is</span>
0644 <span class="comment">% viewed from the left.</span>
0645 <span class="comment">%----------------------------------------------------------------------------</span></pre></div>
<hr><address>Generated on Mon 29-Mar-2004 13:14:32 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/">m2html</a></strong> &copy; 2003</address>
</body>
</html>